#integratd scripts
```{r}
# Load necessary libraries
library(vroom)
library(DOSE)
library(clusterProfiler)
library(dplyr)
library(tidyr)
library(org.Hs.eg.db) 
library(readxl)
library(msigdbr)

# Read your ranked gene list (gene symbols in the first column)
geneList <- read.csv("OBP2B_-1_ranked_geneList.csv", header = TRUE)

# Assuming the first column contains gene symbols and the second column contains values (e.g., logFC)
gene_symbols <- geneList[,1]

# Use bitr to convert gene symbols to Entrez IDs
gene_df <- bitr(gene_symbols, fromType = "SYMBOL", 
                toType = "ENTREZID", 
                OrgDb = org.Hs.eg.db)

# View the converted data
head(gene_df)

# Merging gene_df (with ENTREZIDs) and geneList (with logFC or other values)
merged_data <- merge(gene_df, geneList, by.x = "SYMBOL", by.y = "Gene", all.x = TRUE)

# Rename the column for consistency
colnames(merged_data)[colnames(merged_data) == "OBP2B_.1"] <- "OBP2B_-1"

# Create geneList_with_entrez using merged data with ENTREZIDs and the original values (e.g., logFC)
geneList_with_entrez <- setNames(merged_data$OBP2B_-1, merged_data$ENTREZID)

# View the geneList_with_entrez
head(geneList_with_entrez)

# Sort the geneList in decreasing order
geneList_sorted <- sort(geneList_with_entrez, decreasing = TRUE)

# Use Entrez IDs for further analysis
gene_entrez <- names(geneList_sorted)

# Extract genes based on your desired threshold (e.g., abs(logFC) > 2)
gene <- names(geneList_sorted)[abs(geneList_sorted) > 2]

# Read the cell marker data
cell_marker_data <- read_excel('Cell_marker_Human.xlsx')

# Assuming 'GeneID' is the column with gene IDs and 'cell_name' represents cell names
cells <- cell_marker_data %>%
    dplyr::select(cell_name, GeneID) %>%              # Select relevant columns
    dplyr::mutate(GeneID = strsplit(GeneID, ', ')) %>%  # Split the GeneID column by commas
    tidyr::unnest(GeneID)                             # Unnest the list into rows

# Cell marker over-representation analysis
x <- enricher(gene, TERM2GENE = cells)
head(x)

# Cell marker gene set enrichment analysis
y <- GSEA(geneList_sorted, TERM2GENE = cells)
head(y)

# MSigDb analysis
msigdbr_show_species()

m_df <- msigdbr(species = "Homo sapiens")
head(m_df, 2) %>% as.data.frame

m_t2g <- msigdbr(species = "Homo sapiens", category = "C1") %>% 
  dplyr::select(gs_name, entrez_gene)
head(m_t2g)

em <- enricher(gene, TERM2GENE = m_t2g)
head(em)

C1_t2g <- msigdbr(species = "Homo sapiens", category = "C1") %>% 
  dplyr::select(gs_name, entrez_gene)
head(C1_t2g)

em2 <- GSEA(geneList_sorted, TERM2GENE = C1_t2g)
head(em2)

```
#visualize enrichment rsults
```{r}
# Dotplot for cell marker enrichment results
library(ggplot2)

if (!is.null(x)) {
    dotplot(x, showCategory = 10) + 
        ggtitle("Cell Marker Over-representation Analysis")
}

```

```{r}
# Barplot for enriched cell markers
if (!is.null(x)) {
    barplot(x, showCategory = 10, title = "Top Cell Markers Enriched")
}

```


```{r}
# GSEA result plot
if (!is.null(y)) {
    gseaplot(y, geneSetID = 1)  # Change 1 to the specific ID you want to visualize
}

```
#visualize MSigDb
```{r}
# MSigDB enrichment results barplot
if (!is.null(em)) {
    barplot(em, showCategory = 10, title = "MSigDB Enrichment Results")
}

```






